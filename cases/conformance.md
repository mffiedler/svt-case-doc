# Conformance Tests

## Doc

* [conformance@svt](https://github.com/openshift/svt/tree/master/conformance)
* [extended-test@oc-origin](https://github.com/openshift/origin/tree/master/test/extended)
* [e2e-test@k8s](https://github.com/kubernetes/community/blob/master/contributors/devel/e2e-tests.md)

## Bash wrapper
Check the steps in [conformance readme](https://github.com/openshift/svt/tree/master/conformance)
to see if all the requirements are satisfied.

```sh
# ./svt/conformance/svt_conformance.sh
```


## Manual steps

### Install atomic-openshift-tests (Optional)
The rpm should be installed already by [image_provisioner](https://github.com/openshift/svt/blob/master/image_provisioner/playbooks/roles/openshift-package-install/tasks/main.yaml).

```sh
# yum install atomic-openshift-tests
# yum info atomic-openshift-tests
Loaded plugins: amazon-id, rhui-lb, search-disabled-repos
Installed Packages
Name        : atomic-openshift-tests
Arch        : x86_64
Version     : 3.6.172.0.0
Release     : 1.git.0.6c797dc.el7
Size        : 156 M
Repo        : installed
From repo   : aos
Summary     : Origin Test Suite
URL         : https://github.com/openshift/origin
License     : ASL 2.0
Description : Origin Test Suite

```

### Go and [ginkgo](http://onsi.github.io/ginkgo/)

Go is installed as well.

Check go env:

```sh
# go version
go version go1.8.3 linux/amd64
# which go
/usr/bin/go
# ll /usr/bin/go
lrwxrwxrwx. 1 root root 20 Jul 28 00:06 /usr/bin/go -> /etc/alternatives/go
# alternatives --display go
go - status is auto.
 link currently points to /usr/lib/golang/bin/go
/usr/lib/golang/bin/go - priority 90
 slave gofmt: /usr/lib/golang/bin/gofmt
Current `best' version is /usr/lib/golang/bin/go.
```

Install [ginkgo](http://onsi.github.io/ginkgo/):

```sh
go get github.com/onsi/ginkgo/ginkgo
```

The code of ginkgo will be downloaded into <code>${GOPATH}</code>, by default, <code>$HOME/go</code>.


### Enable master schedulable

```sh
# oc adm manage-node --schedulable=true ip-172-31-5-81.us-west-2.compute.internal
```

### Run the test
It is NOT clear (to me) where <code>KUBE_REPO_ROOT</code> and <code>EXTENDED_TEST_PATH</code>
are used. Seems NOT necessary to clone the origin repo either.


```sh
# KUBECONFIG=/etc/origin/master/admin.kubeconfig \
    TEST_REPORT_DIR=/tmp TEST_REPORT_FILE_NAME=svt-parallel \
    go/bin/ginkgo -v "-focus=EmptyDir|Conformance" "-skip=Serial|Flaky|Disruptive|Slow" \
    --nodes=5  /usr/libexec/atomic-openshift/extended.test
```

Explanation on the above command can be found [here](../origin/extended_test.md).

### Check result
[Report files](http://file.rdu.redhat.com/~hongkliu/test_result/20170815.conformance.test/) generated by ginkgo.

[Summary in terminal output](https://privatebin-it-iso.int.open.paas.redhat.com/?dd85b89ee13029d5#pD+2daSQU+xA+D7mDPK8WGoAIPB2u1X0eINqr1PruGQ=) on Aug 2017: 10 Failures.

Fix some of the failures:
```sh
# oc create -f /usr/share/openshift/examples/image-streams/image-streams-centos7.json -n openshift
```

Although the above command failed up to the fact some of the is(s) existed already, <code>is/wildfly</code>
will be created. Rerun the command leads to

```sh
...
Summarizing 2 Failures:

[Fail] [Conformance][volumes] Test local storage quota FSGroup local storage quota [local] [It] should be applied to XFS filesystem when a pod is created
/builddir/build/BUILD/atomic-openshift-git-0.6c797dc/_output/local/go/src/github.com/openshift/origin/test/extended/localquota/local_fsgroup_quota.go:133

[Fail] [security] supplemental groups [Conformance]Ensure supplemental groups propagate to docker [It] should propagate requested groups to the docker host config [local]
/builddir/build/BUILD/atomic-openshift-git-0.6c797dc/_output/local/go/src/github.com/openshift/origin/test/extended/security/supplemental_groups.go:66

Ran 203 of 866 Specs in 1484.140 seconds
FAIL! -- 201 Passed | 2 Failed | 0 Pending | 663 Skipped

Ginkgo ran 1 suite in 24m45.160400436s
Test Suite Failed
```

## Debug

Let us rerun only one failed test above:

```sh
# KUBECONFIG=/etc/origin/master/admin.kubeconfig \
    TEST_REPORT_DIR=/tmp TEST_REPORT_FILE_NAME=svt-parallel go/bin/ginkgo -v \
    --focus="should propagate requested groups to the docker host config" \
    /usr/libexec/atomic-openshift/extended.test
```

where <code>--focus="should propagate requested groups to the docker host config"</code> is to focus one test with regex.


